# Data Model
Date: 2025-10-16
Feature: Calendar Application Core

## Overview
Entities modeled to support authentication, events, invitations, availability computation, suggestion generation, and ICS import. All timestamps stored in UTC; `timezone` fields retain original zone context (IANA identifier).

## Entities

### User
| Field | Type | Constraints | Notes |
|-------|------|------------|-------|
| id | UUID | PK | Generated server-side |
| googleSub | String | UNIQUE NOT NULL | Google subject identifier |
| email | String | UNIQUE NOT NULL | Lowercased; RFC 5322 basic validation |
| displayName | String | NOT NULL | Trimmed 1..100 chars |
| timezone | String | NOT NULL | IANA TZ (validated) |
| createdAt | Instant | NOT NULL | Immutable |
| updatedAt | Instant | NOT NULL | Updated on change |

Validation: `timezone` must be resolvable via ZoneId; email validated by regex + domain length <=253.

### Event
| Field | Type | Constraints | Notes |
|-------|------|------------|-------|
| id | UUID | PK | |
| organizerId | UUID | FK -> User(id) NOT NULL | Owner |
| title | String | NOT NULL 1..120 chars | |
| description | Text | OPTIONAL | Sanitized (XSS) |
| startDateTime | Instant | NOT NULL | UTC start |
| endDateTime | Instant | NOT NULL > start | UTC end |
| timezone | String | NOT NULL | Original organizer zone |
| recurrenceRule | String | OPTIONAL | RFC 5545 RRULE raw string |
| videoConferenceLink | String | OPTIONAL | Google Meet URL validated by pattern |
| location | String | OPTIONAL | Free-form 0..200 chars |
| createdAt | Instant | NOT NULL | |
| updatedAt | Instant | NOT NULL | |

Indexes: (organizerId,startDateTime), (startDateTime), (endDateTime).

### Invitation
| Field | Type | Constraints | Notes |
|-------|------|------------|-------|
| id | UUID | PK | |
| eventId | UUID | FK -> Event(id) NOT NULL | |
| recipientEmail | String | NOT NULL | Lowercased; may not be a registered User yet |
| status | Enum(pending,accepted,declined,proposed) | NOT NULL | Proposed indicates new time suggestion pending |
| proposedStart | Instant | OPTIONAL | UTC; only when status=proposed |
| proposedEnd | Instant | OPTIONAL > proposedStart | |
| responseNote | String | OPTIONAL | 0..500 chars |
| respondedAt | Instant | OPTIONAL | Set on non-pending |
| createdAt | Instant | NOT NULL | |
| updatedAt | Instant | NOT NULL | |

Indexes: (eventId), (recipientEmail), (status).

State Transitions:
```
PENDING -> ACCEPTED | DECLINED | PROPOSED
PROPOSED -> ACCEPTED (with new time applied) | DECLINED (proposal rejected -> back to PENDING? No, stays DECLINED record) | SUPERSEDED (if another proposal accepted)
ACCEPTED -> (no further transitions except event cancellation scope future)
DECLINED -> (no further transitions)
```

### AvailabilitySlot (Derived / Cached)
| Field | Type | Constraints | Notes |
|-------|------|------------|-------|
| id | UUID | PK | |
| userId | UUID | FK -> User(id) NOT NULL | |
| startDateTime | Instant | NOT NULL | Busy or free segment start |
| endDateTime | Instant | NOT NULL > start | Segment end |
| busy | Boolean | NOT NULL | true=busy segment |
| sourceEventId | UUID | OPTIONAL | Event that produced busy slot |
| generatedAt | Instant | NOT NULL | Cache timestamp |

Retention: TTL configurable (e.g., 15 minutes). Recomputed on event changes.

### Suggestion (Transient / Stored for audit)
| Field | Type | Constraints | Notes |
|-------|------|------------|-------|
| id | UUID | PK | |
| requestId | UUID | NOT NULL | Groups suggestions for a single generation request |
| startDateTime | Instant | NOT NULL | Candidate start |
| endDateTime | Instant | NOT NULL > start | Candidate end |
| score | Decimal(4,2) | NOT NULL | Simple heuristic (earlier=lower score) |
| conflicts | JSON array<UUID> | OPTIONAL | User IDs with partial conflicts (if partial tolerance added later) |
| createdAt | Instant | NOT NULL | |

### RecurrenceExpansion (Optional future table)
Used if ICS recurrence expansions become heavy; MVP may expand in-memory.

## Relationships
- User (1) -> Event (many) via `organizerId`.
- Event (1) -> Invitation (many) via `eventId`.
- User (0..1) <- Invitation(recipientEmail) (implicit linking if user exists).
- AvailabilitySlot (many) -> User (1).
- Suggestion (many) grouped by `requestId` (ephemeral linking to scheduling request context).

## Derived Data & Computations
- AvailabilitySlot derived by subtracting Event busy intervals from a baseline working hours window (e.g., 08:00-18:00 local) per user.
- Suggestions generated by intersecting free windows across participants, filtering by duration & working hours.

## Validation Rules Summary
- Event: endDateTime > startDateTime; duration <= 24h (MVP safety); recurrenceRule validated by RFC 5545 pattern.
- Invitation proposals: proposedEnd > proposedStart; proposed duration must equal original event duration (MVP constraint).
- Timezones: Validate against ZoneId; fallback reject if invalid.
- Emails: Basic regex + domain presence; invitations allow non-registered recipients.

## Index Strategy
- High-frequency queries: events by organizer and time range; invitations by event; suggestions typically ephemeral (may not index beyond PK).
- Potential future composite indexes: (recipientEmail,status) for pending reminders.

## State Machine Definitions
### Invitation Status Machine
```
[PENDING]
  accept -> ACCEPTED
  decline -> DECLINED
  propose(time) -> PROPOSED
[PROPOSED]
  organizer accept -> ACCEPTED (event time updated)
  organizer reject -> DECLINED (proposal closed)
  another proposal accepted -> SUPERSEDED (inform proposing recipient)
[ACCEPTED]
  (terminal)
[DECLINED]
  (terminal)
[SUPERSEDED]
  (terminal informational)
```

## Data Integrity & Concurrency
- Use optimistic locking (version column) on Event when applying time changes due to proposal acceptance.
- Cascading deletes: Deleting Event deletes Invitations and related AvailabilitySlots.
- Prevent overlapping accepted proposals by transactionally checking Event start/end just before update.

## Privacy & Security Considerations
- Invitations store recipient emails; ensure encryption at rest (DB-level) or limit access via service layer.
- Audit fields (createdAt/updatedAt) used for debugging scheduling issues.

## Open Issues (None for MVP)
All clarifications resolved; recurrence suggestion deferral documented in research.

## Future Extensions
- Recurring suggestion logic storing pattern preferences.
- Shared resources (rooms) requiring additional availability dimension.
- Bulk import performance optimization via batching.
